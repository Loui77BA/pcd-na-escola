<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ page.title | default: site.title }} - {{ site.title }}</title>

    <!-- Paleta visual -->
    <link rel="stylesheet" href="{{ '/assets/css/site.css' | relative_url }}">
    <link rel="stylesheet" href="{{ '/assets/css/courses.css' | relative_url }}">
    <link rel="apple-touch-icon" href="{{ '/assets/images/apple-touch-icon.png' | relative_url }}">
    <link rel="apple-touch-icon-precomposed" href="{{ '/assets/images/apple-touch-icon-precomposed.png' | relative_url }}">
    <link rel="icon" type="image/x-icon" href="{{ '/assets/favicon.ico' | relative_url }}">
    <meta name="theme-color" content="#18181d">
    <meta name="color-scheme" content="dark">

    <!-- Material Symbols + Bootstrap Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ '/assets/css/a11y-toolbar.css' | relative_url }}">
    <link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}">
  </head>
  <body id="topo" class="d-flex flex-column h-100">
    {% include navbar.html %}

    <main id="main-content" class="flex-shrink-0 py-4">
      <div class="container">
        {{ content }}
      </div>
    </main>

    {% include footer.html %}
    
    {% include mermaid.html %}

    <!-- BotÃ£o de voltar ao topo -->
    <a href="#topo"
       class="btn btn-outline-light position-fixed bottom-0 end-0 m-3"
       style="z-index: 1000;"
       role="button"
       aria-label="Voltar ao topo da pÃ¡gina">
      <span class="material-symbols-outlined" aria-hidden="true">arrow_upward</span>
    </a>

    <!-- VLibras -->
    <div vw class="enabled" aria-hidden="true" style="z-index: 2147483645;">
      <div vw-access-button class="active" aria-hidden="true"></div>
      <div vw-plugin-wrapper>
        <div class="vw-plugin-top-wrapper" aria-hidden="true"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js" defer></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        new window.VLibras.Widget('https://vlibras.gov.br/app');
      });
    </script>
    <script async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true
        }
      });
    </script>
    
    <!-- A11y Toolbar â€“ comeÃ§o -->
    <!-- CSS movido para assets/css/a11y-toolbar.css -->

    <button id="a11yToggle" class="a11y-toggle" aria-controls="a11yToolbar" aria-expanded="false" aria-hidden="true">
      <span class="material-symbols-outlined" aria-hidden="true">accessibility_new</span>
      <span class="sr-only">OpÃ§Ãµes de acessibilidade</span>
    </button>

    <nav id="a11yToolbar" class="a11y-toolbar" aria-label="Ferramentas de acessibilidade" aria-hidden="true">
      <div class="a11y-title">Ferramentas</div>
      <button type="button" id="a11yInc" aria-label="Aumentar tamanho do texto">ğŸ” Aumentar texto</button>
      <button type="button" id="a11yDec" aria-label="Diminuir tamanho do texto">ğŸ” Diminuir texto</button>
      <button type="button" id="a11yHC" aria-pressed="false" aria-label="Ativar alto contraste">ğŸ¯ Alto contraste</button>
      <button type="button" id="a11yNeg" aria-pressed="false" aria-label="Ativar contraste negativo (inverter cores)">ğŸŒ“ Contraste negativo</button>
      <button type="button" id="a11yGray" aria-pressed="false" aria-label="Ativar escala de cinza">âšª Escala de cinza</button>
      <button type="button" id="a11yUnder" aria-pressed="false" aria-label="Sublinhar links">ğŸ”— Links sublinhados</button>
      <button type="button" id="a11yRead" aria-pressed="false" aria-label="Fonte legÃ­vel">ğŸ…°ï¸ Fonte legÃ­vel</button>
      <button type="button" id="a11yReset" aria-label="Redefinir ajustes">â†©ï¸ Redefinir</button>
    </nav>

    <div id="a11yLive" class="sr-only" aria-live="polite"></div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const html = document.documentElement;
        const body = document.body;
        const $ = (id) => document.getElementById(id);
        const live = $('a11yLive');
  
        // Ajusta posicionamento com base no VLibras
        function adjustAccessibilityPosition() {
          const vlibrasBtnRect = document.querySelector('[vw-access-button]')?.getBoundingClientRect();
          const a11yBtn = document.getElementById('a11yToggle');
          
          if (vlibrasBtnRect && a11yBtn) {
            // Posiciona abaixo do botÃ£o do VLibras com espaÃ§o suficiente
            const vlibrasBottom = vlibrasBtnRect.bottom;
            // Adiciona espaÃ§amento de 20px para evitar sobreposiÃ§Ã£o visual e de interaÃ§Ã£o
            a11yBtn.style.top = (vlibrasBottom + 20) + 'px';
            
            // Posiciona mais prÃ³ximo da borda direita (15px da borda)
            a11yBtn.style.right = '15px';
          }
        }
        
        // Executa no carregamento e quando a janela for redimensionada
        window.addEventListener('resize', adjustAccessibilityPosition);
        // Executa vÃ¡rias vezes apÃ³s o carregamento para garantir que o VLibras esteja inicializado
        setTimeout(adjustAccessibilityPosition, 300);
        setTimeout(adjustAccessibilityPosition, 800);
        setTimeout(adjustAccessibilityPosition, 1500);

        const state = {
          fontScale: 1,
          contrast: false,
          negative: false,
          grayscale: false,
          underline: false,
          readable: false
        };

        // PersistÃªncia
        const load = () => {
          try {
            const saved = JSON.parse(localStorage.getItem('a11yPrefs')||'{}');
            Object.assign(state, saved);
          } catch {}
        };
        const save = () => localStorage.setItem('a11yPrefs', JSON.stringify(state));

        // AplicaÃ§Ã£o de estados
        const apply = () => {
          html.style.setProperty('--a11y-fontscale', state.fontScale);
          if (state.fontScale !== 1) html.setAttribute('data-a11y-fontscale','');
          else html.removeAttribute('data-a11y-fontscale');

          body.classList.toggle('a11y-contrast', state.contrast);
          html.classList.toggle('a11y-negative', state.negative);
          html.classList.toggle('a11y-grayscale', state.grayscale);
          body.classList.toggle('a11y-underline', state.underline);
          body.classList.toggle('a11y-readable', state.readable);

          // Atualiza aria-pressed
          $('a11yHC').setAttribute('aria-pressed', String(state.contrast));
          $('a11yNeg').setAttribute('aria-pressed', String(state.negative));
          $('a11yGray').setAttribute('aria-pressed', String(state.grayscale));
          $('a11yUnder').setAttribute('aria-pressed', String(state.underline));
          $('a11yRead').setAttribute('aria-pressed', String(state.readable));
        };

        const announce = (msg) => { live.textContent = ''; setTimeout(()=> live.textContent = msg, 0); };

        // Controles
        $('a11yInc').addEventListener('click', () => {
          state.fontScale = Math.min(2.0, +(state.fontScale + 0.1).toFixed(2));
          apply(); save(); announce('Texto aumentado');
        });
        $('a11yDec').addEventListener('click', () => {
          state.fontScale = Math.max(0.75, +(state.fontScale - 0.1).toFixed(2));
          apply(); save(); announce('Texto diminuÃ­do');
        });
        $('a11yHC').addEventListener('click', () => {
          state.contrast = !state.contrast;
          // Evita conflito visual entre alto contraste e negativo
          if (state.contrast) state.negative = false;
          apply(); save(); announce(state.contrast ? 'Alto contraste ativado' : 'Alto contraste desativado');
        });
        $('a11yNeg').addEventListener('click', () => {
          state.negative = !state.negative;
          if (state.negative) state.contrast = false;
          apply(); save(); announce(state.negative ? 'Contraste negativo ativado' : 'Contraste negativo desativado');
        });
        $('a11yGray').addEventListener('click', () => {
          state.grayscale = !state.grayscale;
          apply(); save(); announce(state.grayscale ? 'Escala de cinza ativada' : 'Escala de cinza desativada');
        });
        $('a11yUnder').addEventListener('click', () => {
          state.underline = !state.underline;
          apply(); save(); announce(state.underline ? 'Links sublinhados' : 'Links sem sublinhado');
        });
        $('a11yRead').addEventListener('click', () => {
          state.readable = !state.readable;
          apply(); save(); announce(state.readable ? 'Fonte legÃ­vel ativada' : 'Fonte padrÃ£o restaurada');
        });
        $('a11yReset').addEventListener('click', () => {
          Object.assign(state, {fontScale:1, contrast:false, negative:false, grayscale:false, underline:false, readable:false});
          apply(); save(); announce('Ajustes redefinidos');
        });

        // BotÃ£o de acessibilidade
        const toggle = $('a11yToggle');
        const toolbar = $('a11yToolbar');
        
        // Garantir que o event listener seja adicionado depois que os elementos existam
        toggle.addEventListener('click', function(event) {
          event.stopPropagation(); // Impede que o clique seja propagado para o documento
          toolbar.classList.toggle('active');
          const isActive = toolbar.classList.contains('active');
          toggle.setAttribute('aria-expanded', String(isActive));
          console.log("BotÃ£o clicado, estado da toolbar:", isActive ? "ativo" : "inativo");
        });

        // Fechar ao clicar fora
        document.addEventListener('click', (event) => {
          // Verifica se o clique foi fora da toolbar e fora do botÃ£o
          if (toolbar.classList.contains('active') && 
              !toolbar.contains(event.target) && 
              event.target !== toggle &&
              !toggle.contains(event.target)) {
            toolbar.classList.remove('active');
            toggle.setAttribute('aria-expanded', 'false');
          }
        });

        // Inicializa
        load(); apply();
      });
    </script>
    <!-- A11y Toolbar â€“ fim -->
  </body>
</html>
